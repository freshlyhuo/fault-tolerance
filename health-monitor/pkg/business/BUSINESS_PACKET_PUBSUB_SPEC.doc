<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>业务层报文规范 + Pub/Sub 推送接口说明（Health Monitor）</title>
  <style>
    body { font-family: "Microsoft YaHei", "PingFang SC", "Noto Sans CJK SC", Arial, sans-serif; line-height: 1.5; color: #111; }
    h1, h2, h3 { line-height: 1.25; }
    code, pre { font-family: Consolas, Menlo, Monaco, "Courier New", monospace; }
    pre { background: #f6f8fa; padding: 12px; border: 1px solid #d0d7de; border-radius: 6px; overflow-x: auto; }
    table { border-collapse: collapse; width: 100%; margin: 10px 0 16px; }
    th, td { border: 1px solid #d0d7de; padding: 6px 8px; vertical-align: top; }
    th { background: #f6f8fa; }
    blockquote { border-left: 4px solid #d0d7de; margin: 10px 0; padding: 6px 12px; color: #444; background: #fafbfc; }
    .small { color: #444; }
  </style>
</head>
<body>
  <h1>业务层报文规范 + Pub/Sub 推送接口说明（Health Monitor）</h1>

  <blockquote>
    <p>本文档基于当前 health-monitor 业务层解析实现整理。<br/>
    适用范围：服务器端/数据源端通过 Pub/Sub 推送业务层二进制报文到监测端（health-monitor）。</p>
  </blockquote>

  <h2>1. 背景与目标</h2>
  <p>health-monitor 的业务层处理链路为：</p>
  <ol>
    <li>接收业务层报文（原始二进制）</li>
    <li>解析为 <code>BusinessMetrics</code></li>
    <li>交由 <code>Dispatcher</code> 分发：写入 <code>StateManager</code> + 触发阈值告警</li>
  </ol>
  <p>为支持跨进程/跨节点通信，建议由服务器端通过 Pub/Sub 向监测端推送“原始二进制报文”（监测端保持对字段语义的唯一解释源）。</p>

  <h2>2. Pub/Sub 推送接口（建议）</h2>

  <h3>2.1 Topic</h3>
  <ul>
    <li>Topic 名称（建议）：<code>healthmonitor.business.packet.v1</code></li>
  </ul>
  <blockquote>
    <p class="small">说明：<br/>
    - <code>v1</code> 表示消息体字段/语义版本（与二进制报文格式版本可同步，也可独立演进）。</p>
  </blockquote>

  <h3>2.2 消息体（建议）</h3>
  <p>建议在 Pub/Sub 消息外层携带最小元数据，便于去重、排障、跨网络传输诊断。</p>
  <ul>
    <li><code>packet</code>：bytes（必填）
      <ul>
        <li>即“业务层二进制报文”，格式见第 3 节。</li>
      </ul>
    </li>
    <li><code>sequence</code>：uint64（建议）
      <ul>
        <li>单调递增序号，用于去重/乱序处理。</li>
      </ul>
    </li>
    <li><code>source</code>：string（建议）
      <ul>
        <li>数据源标识（如节点名、设备号）。</li>
      </ul>
    </li>
    <li><code>server_timestamp</code>：int64（建议，Unix 秒或毫秒二选一，需明确）
      <ul>
        <li>服务器产生/采集该报文的时间戳。</li>
      </ul>
    </li>
  </ul>

  <p>兼容性策略：</p>
  <ul>
    <li>新增字段优先“向后兼容”（旧订阅者忽略未知字段）。</li>
    <li><code>packet</code> 字段必须存在且符合基础帧格式，否则监测端应丢弃该消息并记录错误。</li>
  </ul>

  <h2>3. 业务层二进制报文：基础帧格式（通用）</h2>
  <p>所有业务层报文采用相同基础帧：</p>

  <table>
    <thead>
      <tr>
        <th>字段</th>
        <th>偏移</th>
        <th>长度</th>
        <th>类型</th>
        <th>端序</th>
        <th>说明</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>ComponentType</td>
        <td>0</td>
        <td>1</td>
        <td>uint8</td>
        <td>-</td>
        <td>组件编号/报文类型</td>
      </tr>
      <tr>
        <td>PayloadLength</td>
        <td>1</td>
        <td>2</td>
        <td>uint16</td>
        <td>Big Endian</td>
        <td>负载长度 N</td>
      </tr>
      <tr>
        <td>Payload</td>
        <td>3</td>
        <td>N</td>
        <td>bytes</td>
        <td>-</td>
        <td>负载数据</td>
      </tr>
    </tbody>
  </table>

  <p>校验规则：</p>
  <ul>
    <li>若 <code>PayloadLength &gt; len(packet) - 3</code>：判定为非法报文（长度不匹配），直接丢弃。</li>
    <li>若 <code>ComponentType</code> 未定义：判定为非法报文（unknown type），直接丢弃。</li>
  </ul>

  <h2>4. ComponentType（组件编号）定义</h2>
  <table>
    <thead>
      <tr>
        <th>组件</th>
        <th>值(hex)</th>
        <th>说明</th>
      </tr>
    </thead>
    <tbody>
      <tr><td>RunMgr</td><td>0x01</td><td>运行管理</td></tr>
      <tr><td>Comm</td><td>0x02</td><td>通信服务（CAN/串口/空空通信等）</td></tr>
      <tr><td>Power</td><td>0x03</td><td>供电服务</td></tr>
      <tr><td>RailCtrl</td><td>0x04</td><td>轨道控制</td></tr>
      <tr><td>Payload</td><td>0x05</td><td>载荷</td></tr>
      <tr><td>Thermal</td><td>0x06</td><td>热控服务</td></tr>
      <tr><td>AttCtrl</td><td>0x07</td><td>姿态控制</td></tr>
      <tr><td>Measure</td><td>0x08</td><td>测量</td></tr>
      <tr><td>Optical</td><td>0x09</td><td>光电设备</td></tr>
      <tr><td>Sensor</td><td>0x0A</td><td>敏感器</td></tr>
      <tr><td>Actuator</td><td>0x0B</td><td>姿态控制机构（动量轮）</td></tr>
      <tr><td>Transceiver</td><td>0x0C</td><td>通信机</td></tr>
      <tr><td>Thruster</td><td>0x0D</td><td>推进器</td></tr>
      <tr><td>EPS</td><td>0x0E</td><td>电源</td></tr>
    </tbody>
  </table>

  <h2>5. Payload 格式定义（逐组件）</h2>
  <p>说明：</p>
  <ul>
    <li>表格中的“偏移”相对于 Payload 起始位置（Payload[0]）。</li>
    <li>多字节整数均使用 Big Endian。</li>
    <li><code>int16/int8</code> 表示有符号整型（补码）。</li>
  </ul>

  <h3>5.1 RunMgr（0x01）</h3>
  <p>PayloadLength：5</p>
  <table>
    <thead>
      <tr><th>字段</th><th>偏移</th><th>长度</th><th>类型</th><th>缩放/单位</th><th>说明</th></tr>
    </thead>
    <tbody>
      <tr><td>Temperature</td><td>0</td><td>2</td><td>uint16</td><td>值/10 ℃</td><td>温度</td></tr>
      <tr><td>Voltage</td><td>2</td><td>2</td><td>uint16</td><td>值/1000 V</td><td>电压</td></tr>
      <tr><td>StatusCode</td><td>4</td><td>1</td><td>uint8</td><td>-</td><td>状态码</td></tr>
    </tbody>
  </table>

  <h3>5.2 Comm（0x02）</h3>
  <p>PayloadLength：18（强烈建议固定为 18）</p>
  <table>
    <thead>
      <tr><th>字段</th><th>偏移</th><th>长度</th><th>类型</th><th>说明</th></tr>
    </thead>
    <tbody>
      <tr><td>SNR</td><td>0</td><td>1</td><td>uint8</td><td>信噪比</td></tr>
      <tr><td>Rate</td><td>1</td><td>2</td><td>uint16</td><td>速率</td></tr>
      <tr><td>CANStatus</td><td>3</td><td>1</td><td>uint8</td><td>CAN 状态</td></tr>
      <tr><td>SerialStatus</td><td>4</td><td>1</td><td>uint8</td><td>串口状态</td></tr>
      <tr><td>AirToAirStatus</td><td>5</td><td>1</td><td>uint8</td><td>空空通信状态</td></tr>
      <tr><td>ParityErrorCount</td><td>6</td><td>2</td><td>uint16</td><td>奇偶校验错误计数</td></tr>
      <tr><td>FrameHeaderErrorCount</td><td>8</td><td>2</td><td>uint16</td><td>帧头错误计数</td></tr>
      <tr><td>FrameLengthErrorCount</td><td>10</td><td>2</td><td>uint16</td><td>帧长错误计数</td></tr>
      <tr><td>SerialResetCount</td><td>12</td><td>2</td><td>uint16</td><td>串口复位计数</td></tr>
      <tr><td>ReceiveCmdCount</td><td>14</td><td>4</td><td>uint32</td><td>命令接收计数</td></tr>
    </tbody>
  </table>
  <p><strong>实现备注（与当前解析逻辑对齐）</strong>：解析会读取到 offset 17（即 18 字节）。服务器端必须发送足够长度，避免监测端越界或解析失败。</p>

  <h3>5.3 Power（0x03）</h3>
  <p>PayloadLength：14</p>
  <table>
    <thead>
      <tr><th>字段</th><th>偏移</th><th>长度</th><th>类型</th><th>缩放/单位</th><th>说明</th></tr>
    </thead>
    <tbody>
      <tr><td>PowerModule12V</td><td>0</td><td>2</td><td>uint16</td><td>值/1000 V</td><td>12V 模块电压</td></tr>
      <tr><td>BatteryVoltage</td><td>2</td><td>2</td><td>uint16</td><td>值/1000 V</td><td>电池电压</td></tr>
      <tr><td>BusVoltage</td><td>4</td><td>2</td><td>uint16</td><td>值/1000 V</td><td>总线电压</td></tr>
      <tr><td>CPUVoltage</td><td>6</td><td>2</td><td>uint16</td><td>值/1000 V</td><td>CPU 电压</td></tr>
      <tr><td>ThermalRefVoltage</td><td>8</td><td>2</td><td>uint16</td><td>值/1000 V</td><td>热控基准电压</td></tr>
      <tr><td>Bracket12VCurrent</td><td>10</td><td>2</td><td>uint16</td><td>值/1000 A</td><td>支架 12V 电流</td></tr>
      <tr><td>LoadCurrent</td><td>12</td><td>2</td><td>uint16</td><td>值/1000 A</td><td>负载电流</td></tr>
    </tbody>
  </table>

  <h3>5.4 RailCtrl（0x04）</h3>
  <p>PayloadLength：1</p>
  <table>
    <thead>
      <tr><th>字段</th><th>偏移</th><th>长度</th><th>类型</th><th>说明</th></tr>
    </thead>
    <tbody>
      <tr><td>OrbitMode</td><td>0</td><td>1</td><td>uint8</td><td>轨控模式</td></tr>
    </tbody>
  </table>

  <h3>5.5 Payload（0x05）</h3>
  <p>PayloadLength：1</p>
  <table>
    <thead>
      <tr><th>字段</th><th>偏移</th><th>长度</th><th>类型</th><th>说明</th></tr>
    </thead>
    <tbody>
      <tr><td>WorkMode</td><td>0</td><td>1</td><td>uint8</td><td>载荷工作模式</td></tr>
    </tbody>
  </table>

  <h3>5.6 Thermal（0x06）</h3>
  <p>PayloadLength：31</p>
  <table>
    <thead>
      <tr><th>字段</th><th>偏移</th><th>长度</th><th>类型</th><th>缩放/单位</th><th>说明</th></tr>
    </thead>
    <tbody>
      <tr><td>ThermalTemps[0..9]</td><td>0</td><td>20</td><td>10×int16</td><td>值/10 ℃</td><td>10 个温度点（每点 2 字节）</td></tr>
      <tr><td>BatteryTemp1</td><td>20</td><td>2</td><td>int16</td><td>值/10 ℃</td><td>蓄电池温度 1</td></tr>
      <tr><td>BatteryTemp2</td><td>22</td><td>2</td><td>int16</td><td>值/10 ℃</td><td>蓄电池温度 2</td></tr>
      <tr><td>PlatformThermalTemp</td><td>24</td><td>2</td><td>int16</td><td>值/10 ℃</td><td>平台热控温度</td></tr>
      <tr><td>BatteryThermalTemp</td><td>26</td><td>2</td><td>int16</td><td>值/10 ℃</td><td>电池热控温度</td></tr>
      <tr><td>TankThermalTemp</td><td>28</td><td>2</td><td>int16</td><td>值/10 ℃</td><td>罐体/储罐热控温度</td></tr>
      <tr><td>SwitchState</td><td>30</td><td>1</td><td>uint8</td><td>位标志</td><td>加热器开关状态</td></tr>
    </tbody>
  </table>
  <p>SwitchState 位定义：</p>
  <ul>
    <li>bit0 (0x01)：PlatformHeaterSwitch（平台加热器）</li>
    <li>bit1 (0x02)：BatteryHeaterSwitch（电池加热器）</li>
    <li>bit2 (0x04)：TankHeaterSwitch（罐体加热器）</li>
    <li>其余位保留</li>
  </ul>

  <h3>5.7 AttCtrl（0x07）</h3>
  <p>PayloadLength：1</p>
  <table>
    <thead>
      <tr><th>字段</th><th>偏移</th><th>长度</th><th>类型</th><th>说明</th></tr>
    </thead>
    <tbody>
      <tr><td>ControlMode</td><td>0</td><td>1</td><td>uint8</td><td>姿态控制模式</td></tr>
    </tbody>
  </table>

  <h3>5.8 Measure（0x08）</h3>
  <p>PayloadLength：4</p>
  <table>
    <thead>
      <tr><th>字段</th><th>偏移</th><th>长度</th><th>类型</th><th>说明</th></tr>
    </thead>
    <tbody>
      <tr><td>SensorValue</td><td>0</td><td>4</td><td>uint32</td><td>测量值</td></tr>
    </tbody>
  </table>

  <h3>5.9 Optical（0x09）</h3>
  <p>PayloadLength：2</p>
  <table>
    <thead>
      <tr><th>字段</th><th>偏移</th><th>长度</th><th>类型</th><th>说明</th></tr>
    </thead>
    <tbody>
      <tr><td>PhotoCurrent</td><td>0</td><td>2</td><td>uint16</td><td>光电流</td></tr>
    </tbody>
  </table>

  <h3>5.10 Sensor（0x0A）</h3>
  <p>PayloadLength：6</p>
  <table>
    <thead>
      <tr><th>字段</th><th>偏移</th><th>长度</th><th>类型</th><th>说明</th></tr>
    </thead>
    <tbody>
      <tr><td>AccX</td><td>0</td><td>2</td><td>int16</td><td>加速度 X</td></tr>
      <tr><td>AccY</td><td>2</td><td>2</td><td>int16</td><td>加速度 Y</td></tr>
      <tr><td>AccZ</td><td>4</td><td>2</td><td>int16</td><td>加速度 Z</td></tr>
    </tbody>
  </table>

  <h3>5.11 Actuator（0x0B）</h3>
  <p>PayloadLength：6</p>
  <table>
    <thead>
      <tr><th>字段</th><th>偏移</th><th>长度</th><th>类型</th><th>说明</th></tr>
    </thead>
    <tbody>
      <tr><td>WheelSpeedX</td><td>0</td><td>2</td><td>int16</td><td>动量轮 X 轴转速</td></tr>
      <tr><td>WheelSpeedY</td><td>2</td><td>2</td><td>int16</td><td>动量轮 Y 轴转速</td></tr>
      <tr><td>WheelSpeedZ</td><td>4</td><td>2</td><td>int16</td><td>动量轮 Z 轴转速</td></tr>
    </tbody>
  </table>

  <h3>5.12 Transceiver（0x0C）</h3>
  <p>PayloadLength：7</p>
  <table>
    <thead>
      <tr><th>字段</th><th>偏移</th><th>长度</th><th>类型</th><th>说明</th></tr>
    </thead>
    <tbody>
      <tr><td>TransmitPower</td><td>0</td><td>1</td><td>uint8</td><td>发射功率</td></tr>
      <tr><td>TelemetryEncryptStatus</td><td>1</td><td>1</td><td>uint8</td><td>遥测加密状态</td></tr>
      <tr><td>TelecontrolEncryptStatus</td><td>2</td><td>1</td><td>uint8</td><td>遥控加密状态</td></tr>
      <tr><td>TransmitSwitch</td><td>3</td><td>1</td><td>uint8</td><td>发射开关</td></tr>
      <tr><td>InfoChannelSNR</td><td>4</td><td>1</td><td>uint8</td><td>信息通道信噪比</td></tr>
      <tr><td>Reserved</td><td>5</td><td>1</td><td>uint8</td><td>保留（当前未使用）</td></tr>
      <tr><td>ReceiveRSSI</td><td>6</td><td>1</td><td>int8</td><td>接收 RSSI</td></tr>
    </tbody>
  </table>

  <h3>5.13 Thruster（0x0D）</h3>
  <p>PayloadLength：5</p>
  <table>
    <thead>
      <tr><th>字段</th><th>偏移</th><th>长度</th><th>类型</th><th>说明</th></tr>
    </thead>
    <tbody>
      <tr><td>FuelLevel</td><td>0</td><td>2</td><td>uint16</td><td>燃料余量/液位</td></tr>
      <tr><td>PipelineSwitch</td><td>2</td><td>1</td><td>uint8</td><td>管路开关</td></tr>
      <tr><td>PressureSensor</td><td>3</td><td>2</td><td>uint16</td><td>压力传感器</td></tr>
    </tbody>
  </table>

  <h3>5.14 EPS（0x0E）</h3>
  <p>PayloadLength：4</p>
  <table>
    <thead>
      <tr><th>字段</th><th>偏移</th><th>长度</th><th>类型</th><th>缩放/单位</th><th>说明</th></tr>
    </thead>
    <tbody>
      <tr><td>Voltage</td><td>0</td><td>2</td><td>uint16</td><td>值/1000 V</td><td>电压</td></tr>
      <tr><td>Current</td><td>2</td><td>2</td><td>uint16</td><td>值/1000 A</td><td>电流</td></tr>
    </tbody>
  </table>

  <h2>6. 发送端实现要求（服务器端）</h2>
  <ul>
    <li>严格使用 Big Endian 编码多字节整数。</li>
    <li><code>PayloadLength</code> 必须等于实际 Payload 字节数。</li>
    <li>对每个 ComponentType 建议固定 <code>PayloadLength</code>，与第 5 节一致。</li>
    <li>若需要扩展：优先在 payload 中新增“保留字段/尾部字段”，并通过 topic 版本或 ComponentType 子版本控制兼容。</li>
  </ul>

  <h2>7. 示例（结构示意）</h2>
  <p>以 RunMgr（0x01）为例：</p>
  <pre>
+-------------+----------------+-------------------------------+
| 0x01        | 0x00 0x05      | Temp[2] Volt[2] Status[1]     |
| (type)      | (len=5)        | payload                       |
+-------------+----------------+-------------------------------+
  </pre>

  <h2>8. 监测端处理行为（概述）</h2>
  <p>监测端收到 Pub/Sub 消息后：</p>
  <ul>
    <li>解析 <code>packet</code> → <code>BusinessMetrics</code></li>
    <li>写入 <code>StateManager</code></li>
    <li>执行阈值判断生成告警（业务层目前以阈值告警为主）</li>
  </ul>
  <blockquote>
    <p class="small">如需在 Pub/Sub 层面实现 ACK/重试/堆积策略，请结合你们使用的 VSOA 中间件能力补充（不同实现差异较大）。</p>
  </blockquote>
</body>
</html>
