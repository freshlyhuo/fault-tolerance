一、引言
在“基于时-空多维度数据的关键软件容错”总体框架下，本健康监测模块承担着系统全局态势感知入口的角色。随着卫星/在轨软件系统业务复杂度增加，服务之间的耦合关系呈现动态演化特征，单一维度的数据监控已难以支撑高可靠性的实时容错需求。
因此，本模块对业务层报文、微服务运行状态、容器实例、节点资源等多源数据进行统一采集、解析与智能评估。借助规则引擎与可扩展的智能分析策略，健康监测模块不仅产生基础告警事件，还能够对告警进行去抖动、相关性融合与优先级推理，为后续故障树诊断和服务恢复策略提供高质量、上下文完整的输入。结合 ECSM 微服务平台提供的实时运行态势数据，本模块能够在资源受限的约束下实现轻量级、智能化的监测能力。
健康监测模块是实现“基于时-空多维度数据的关键软件容错”的关键环节，是整个容错体系的实时数据基座、智能发现引擎与风险前置装置。其设计目标是以智能化方式最大化利用时-空多维度监测数据，提高关键服务运行的可观测性、可诊断性与可治理能力。

二、需求分析
2.1 需求目标
本模块为“监测—诊断—修复”闭环的监测端，负责将业务层（应用报文/遥测）与微服务层（容器/节点/服务）两类时序数据标准化为基础告警事件并推送给故障诊断模块。目标包括：完整解析并采集业务层报文（遵循应用层格式设计稿），提取用于故障树判断的业务指标。通过调用 ECSM 平台 API 周期性/事件性获取微服务层态势（CPU/内存/容器状态/重启次数/网络流量等），并按预设规则生成微服务层告警。提供统一的告警事件格式、去抖动与阈值策略、状态机接口（与状态管理器交互），并保证在资源受限环境下的轻量实现与高可靠性。
	
2.2 设计原则
为满足航天器在轨环境的极端约束，本框架的设计遵循以下核心原则：
（1）时-空多维度感知原则：健康监测必须利用多源异构数据（业务层报文、容器、节点、服务拓扑、资源占用、时序变化趋势等），从时间、空间、拓扑结构与业务语义四个维度进行融合监测。
（2）智能化与动态自适应原则：监测阈值、告警合并、持续时间判断、噪声抑制等需具备智能化能力，从静态阈值转向趋势感知、上下文感知和多指标联合判断，实现自适应健康评估。
（3）可观测性与可追溯性原则：所有告警事件、原始数据片段、上下文信息必须可追溯，以支持故障诊断、链路分析、人工复核与地面验证。

三、概要设计
3.1支撑框架设计
健康监测模块是框架的感知层，负责将底层物理和软件世界的连续状态流，转化为上层逻辑可以处理的、离散的、标准化的告警事件 (Alert Event)。
健康监测模块由两个个职责高度分明的监听模块、一个统一的处理单元和一个状态管理器构成，确保对卫星的全栈健康状况进行无死角覆盖。


图3.1 健康监测模块架构图
业务层监听模块: 负责感知业务层的状态。订阅星务共性服务接收原始二进制数据帧。对数据帧进行解码，根据字节偏移和位长度提取监测数据值。
微服务层监听模块: 负责感知微服务的状态。定期通过调用翼辉ECSM平台的API，获取所有受管容器的底层资源占用数据（CPU使用率、内存消耗）和生命周期状态（运行中、已退出、崩溃）以及网络流量等。
告警生成器: 所有监控数据的汇聚与处理中心。负责将连续的监测数据流转化为离散的告警事件。统一告警生成器将实时监测值与预配置的告警规则（如 电压 < 3.1V, 延迟 > 5000ms, 容器状态 == crashed）进行比较。
一旦确认告警条件成立，立即生成一个标准化的告警事件，并将其推送到故障诊断模块的输入队列中。
状态管理器：保存历史时间维度上的监测数据，并为所有受管服务提供了一个一致的状态视图，并以此为依据，确保所有故障修复决策具备正确的上下文，避免冲突与误判。
3.2核心工作流程
第一步：多维度数据采集
1.数据监听：业务层通过业务监听器实时接收共性服务的应用层报文。微服务层通过ECSM平台周期拉取节点、容器和服务状态，
2. 数据解析与标准化：业务监听器对原始字节流进行：组帧、长度校验、CRC/数字签名校验、按PDU类型进行字段解析提取业务层指标。微服务监听器解析ECSM返回的JSON数据。
第二步：异常指标判断
1. 静态阈值判断：对指标与预设阈值进行直接比较，例如：CPU使用率、电压参数超出安全区间。
2. 趋势判断：在时序数据中寻找潜在的异常趋势，如连续 N 次 CPU 占用上升（趋势上升）、节点负载在多个周期内保持高位（长期过载）
3. 时空多维度关联判断：模块关联以下信息：时间维度：多个异常是否集中发生在同一时间窗口；空间维度：异常是否沿同一拓扑链路发生。
第三步：告警事件生成
1. 告警事件构建：对于每一项确认异常，生成对应的基础告警事件，包括：告警类型（事件编号）、来源（业务层/容器/节点/服务）、时间戳、关键字段（阈值、实际值、PDU 字段、容器 ID 等）、拓扑上下文（所在服务链）
2. 告警优化：对所有事件进行：去抖动：过滤短暂波动，避免误报；合并事件：多个容器异常 → 合并成服务异常；压缩重复事件：同类告警频繁出现 → 只保留关键一条；抬升优先级：关键业务服务的异常优先
例如：文件连续 3 次校验失败 → 合并为一次“文件校验失败（批量）”
3. 生成最终告警事件：最终输出告警事件包含：完整结构化告警；时空上下文（服务拓扑、节点位置）；异常关联关系（如“链路能力下降”）；必要的元数据（trace ID、session ID）
这些事件将传递给故障树诊断模块，用于进一步推断根因并决定是否触发自动修复。


四、详细设计
健康监测模块由四个核心部件组成：业务监听器、微服务监听器、告警生成器与状态管理器。四个部件协同工作，完成数据采集、指标解析、健康判断和告警输出。本节对各部件的输入、功能和输出进行优化描述。
4.1 业务监听器
技术栈对应实现：
语言：Go
并发模型：Goroutine + Channel
通信方式：订阅星务共性服务数据流
输入：原始字节流（来自总线/链路）
核心功能：业务监听器负责对业务层报文进行实时接收与解析，包括：
1.报文完整性处理：主要实现、报文组帧、长度字段校验以及CRC或数字签名校验。
2.协议解析：根据不同 PDU 类型（Meta、File Data、EOF、Completed、Failed 等）解析字段并提取业务指标（会话 ID、偏移量、文件序号、校验值、状态字段等）
核心功能	对应函数	说明
报文接收	ReceiveRawFrame()	从链路读取原始字节流
报文组帧与校验	AssembleAndVerify(raw []byte) ([]byte, error)	组帧、长度校验、CRC/签名校验
PDU 类型识别与解析	ParsePDU(frame []byte) (PDUEvent, error)	根据 PDU 类型解析字段
提取业务指标	ExtractBusinessMetrics(pdu PDUEvent) BusinessMetric	提取 SessionID、Offset 等
生成业务异常指标	GenerateBusinessError(err error) BusinessMetric	校验失败、解析失败等错误输出
输出到状态管理器	DispatchBusinessMetric(metric BusinessMetric)	推送至状态管理器

输出：标准化业务指标（结构化业务数据）以及PDU 事件（如校验失败、元数据解析失败等）。


4.2 微服务监听器
技术栈对应实现：
使用Go HTTP Client 调用 ECSM API，JSON 解析使用 encoding/json，定时任务使用 time.Ticker
输入：ECSM 平台 API 返回的 JSON
核心功能：微服务监听器负责采集微服务运行状态并生成微服务层指标，具体包含：
1.JSON 解析与指标结构化
2.节点/容器/服务状态获取
3.构建服务拓扑
输出：标准化微服务指标、拓扑结构。
核心功能	对应函数	说明
ECSM 状态获取	FetchECSMStatus()	调用 ECSM API 获取 JSON
JSON 解析	ParseECSMJSON(resp []byte) ECSMMetrics	解析为结构化指标
提取节点指标	ExtractNodeMetrics(ecsm ECSMMetrics) NodeMetric	CPU、RAM、磁盘、网络等
提取容器指标	ExtractContainerMetrics(ecsm ECSMMetrics) []ContainerMetric	重启次数、状态等
提取服务指标	ExtractServiceMetrics(ecsm ECSMMetrics) []ServiceMetric	health 状态等
构建服务拓扑	BuildTopology(ecsm ECSMMetrics) TopologySnapshot	Service → Container → Node
推送至状态管理器	DispatchECSMMetrics(metric Metric)	统一入口

4.3 状态管理器
技术栈对应实现
Go 内存结构体 + map + ring buffer
锁机制：sync.RWMutex
轻量级数据库：BoltDB用于 短期指标缓存 与 状态快照持久化
输入: 来自监听器的指标事件，以及告警生成器可能产生的状态更新请求，以及执行器的受管服务状态。
核心功能：业务监听器负责对业务层报文进行实时接收与解析，包括：
1. 实时状态视图维护：保存节点、容器、服务、业务层的最新状态
2. 历史数据短期缓存：缓存近几分钟的关键指标，为趋势与时序相关分析提供支持
3. 统一查询接口：向告警生成器提供一致的数据视图、支持查询：服务健康度、容器重启轨迹、节点负载变化等
4. 数据一致性保障：对不同来源指标进行时间戳对齐，维护拓扑的最新快照，清理已过期状态片段
核心功能	对应函数	说明
实时状态更新	UpdateMetric(metric Metric)	更新节点/容器/服务/业务的最新状态
状态查询接口	GetLatestState(id string)	查询某节点/容器/服务最新状态
历史序列缓存	AppendHistory(metric Metric)	写入短期历史，用于趋势判断
历史序列查询	QueryHistory(id string, dur time.Duration)	供告警生成器使用
拓扑快照更新	UpdateTopology(topo TopologySnapshot)	更新拓扑结构
数据一致性维护	AlignTimestamp(metric Metric)	时间对齐、清理过期数据

输出: 为其他组件提供查询结果和数据视图。本身不直接输出事件，而是作为数据中枢支撑其他组件的工作。

4.4 告警生成器
技术栈对应实现
Go 规则引擎（内部实现）
滑动窗口趋势分析（ring buffer）
输入：业务层监听器业务指标、PDU事件；微服务监听器的微服务指标、拓扑结构。
核心功能：告警生成器根据业务监听器和微服务监听器产生的指标进行综合判断，包含以下环节：
1.趋势判断：使用滑动窗口方法分析指标趋势，常见趋势包含如业务校验失败率持续上升、容器重启次数呈加速度增长、节点 CPU 长期高位
2. 时空关联分析：
时间相关性：判断错误事件是否在 30–60 秒窗口内聚集
空间相关性：结合服务拓扑判断异常是否沿同一链路传递。
3. 告警优化处理：去抖动（避免瞬时波动触发告警）、告警压缩（同类事件合并）以及关键业务优先级提升（提升为高等级告警）
4. 告警生成：综合上述判断，形成告警。
核心功能	对应函数	说明
阈值判断	EvaluateThreshold(metric Metric) *AlertEvent	判断是否越限
趋势分析（滑动窗口）	EvaluateTrend(id string) *AlertEvent	基于状态管理器的历史序列
时间关联（30–60 秒窗口）	CheckTemporalCorrelation(events []Event) bool	判断是否同一时间段
空间关联（沿拓扑链路）	CheckSpatialCorrelation(events []Event, topo TopologySnapshot) bool	判断节点→容器→服务→业务是否相关
告警去抖动	Debounce(alert AlertEvent) bool	防止频繁告警
告警合并/提升	RefineAlerts(alerts []AlertEvent) AlertEvent	合并并提升优先级

输出：告警事件

4.5 测试规划
1.功能测试：
测试 业务层监听器PDU解析正确性
测试 微服务监听器ECSM数据解析正确性
测试状态管理器缓存是否正确更新
测试告警生成器告警规则触发逻辑
2. 集成测试：
模拟真实链路：
业务报文模拟器 → 业务层监听器
ECSM JSON 仿真器 → 微服务层监听器
验证：是否能够生成正确告警、时空关联逻辑是否生效
4.可靠性测试：
高频数据输入下的稳定性、内存泄漏检测