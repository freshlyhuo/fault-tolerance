# 健康监测 + 故障诊断 集成测试

## 概述

集成测试验证健康监测和故障诊断两个模块的协同工作，包括：
- 业务层故障检测与诊断
- 微服务层故障检测与诊断
- 告警状态跟踪
- 恢复告警生成
- 故障树逻辑验证

## 测试版本

### 1. 简化版测试 (推荐)

**特点：**
- 纯模拟数据测试
- 无需外部依赖
- 快速验证核心功能

**运行：**
```bash
cd /home/yzj/fault-tolerance
chmod +x run_integration_simple.sh
./run_integration_simple.sh
```

**测试场景：**
- ✅ 场景1: 所有指标正常（无告警）
- ✅ 场景2: 蓄电池电压异常（触发告警）
- ✅ 场景3: 蓄电池+母线电压异常（触发故障诊断）
- ✅ 场景4: CPU板电压异常（AD模块故障）
- ✅ 场景5: 指标恢复正常（恢复告警）
- ✅ 场景6: 容器CPU过高
- ✅ 场景7: 容器CPU+内存过高（级联故障）
- ✅ 场景8: 容器指标恢复

### 2. 完整版测试

**特点：**
- 业务层：模拟数据
- 微服务层：ECSM实时监测
- 持续运行，实时监测

**运行：**
```bash
cd /home/yzj/fault-tolerance
chmod +x run_integration_test.sh
./run_integration_test.sh
```

**要求：**
- ECSM 服务运行中
- 有真实容器运行

## 测试流程

```
健康监测模块                                故障诊断模块
    │                                           │
    │ 1. 采集指标                                 │
    │   - 业务层：模拟数据                          │
    │   - 微服务层：ECSM/模拟                       │
    │                                           │
    │ 2. 阈值检查（使用状态管理器）                  │
    │   ├─ 状态变化？                              │
    │   │   └─ 是 → 生成告警                      │
    │   │       ├─ firing (触发)                 │
    │   │       └─ resolved (恢复)               │
    │   └─ 无变化 → 跳过                          │
    │                                           │
    │ 3. 发送告警 ──────────────────────────────→ │
    │                                           │
    │                                           │ 4. 更新基本事件状态
    │                                           │   - firing → TRUE
    │                                           │   - resolved → FALSE
    │                                           │
    │                                           │ 5. 执行故障树求值
    │                                           │   - 评估门逻辑
    │                                           │   - 检查顶层事件
    │                                           │
    │                                           │ 6. 触发故障？
    │                                           │   └─ 是 → 输出诊断
    │                                           │
    │ ←─────────────── 诊断结果 ──────────────────┘
```

## 验证点

### 业务层故障诊断

| 场景 | 触发条件 | 预期结果 | 故障码 |
|------|---------|---------|-------|
| 蓄电池异常 | EVT-001 AND EVT-002 AND NOT EVT-003 | 触发故障 | CJB-RG-ZD-3 |
| AD模块异常 | EVT-003 | 触发故障 | CJB-RG-ZD-3 |

**基本事件：**
- EVT-001: 蓄电池电压异常 (< 21V 或 > 29.4V)
- EVT-002: 母线电压异常 (< 24V 或 > 28V)
- EVT-003: CPU板电压异常 (< 3.1V 或 > 3.5V)

### 微服务层故障诊断

| 场景 | 触发条件 | 预期结果 | 故障码 |
|------|---------|---------|-------|
| CPU过载 | 容器CPU > 90% | 触发故障 | SVC-PERF-001, CONTAINER-RESOURCE-001 |
| 容器资源耗尽 | CPU > 90% OR 内存 > 90% | 触发故障 | CONTAINER-RESOURCE-001 |
| 级联故障 | CPU过载 AND 容器资源耗尽 | 触发故障 | SVC-CASCADE-001 |

### 恢复告警测试

| 测试项 | 验证内容 |
|-------|---------|
| 告警状态跟踪 | 状态管理器正确记录告警状态 |
| 触发告警 | 指标异常时生成 firing 告警 |
| 恢复告警 | 指标正常时生成 resolved 告警 |
| 状态更新 | 诊断引擎正确处理 resolved 告警，将基本事件置为 FALSE |
| 不重复发送 | 状态未变化时不重复发送告警 |

## 输出示例

### 正常流程

```
📌 场景 2: 蓄电池电压异常 (触发告警)
  🔴 发送告警: BATTERY_VOLTAGE_ALERT (firing)
  [诊断] 收到告警: BATTERY_VOLTAGE_ALERT (status=firing, severity=critical)
  [诊断结果] 未触发顶层故障（需要更多证据）
```

### 故障触发

```
📌 场景 3: 蓄电池和母线电压同时异常 (应触发故障诊断)
  🔴 发送告警: BUS_VOLTAGE_ALERT (firing)
  [诊断] 收到告警: BUS_VOLTAGE_ALERT (status=firing, severity=warning)

══════════════════════════════════════════════════════════════════
🚨 检测到系统级故障!
══════════════════════════════════════════════════════════════════
  📋 诊断ID:     DIAG-20251226-143025
  ⚠️  故障码:     CJB-RG-ZD-3
  📊 顶层事件:   蓄电池、母线电压遥测异常
  📝 故障原因:   蓄电池异常
  ⏰ 诊断时间:   2025-12-26 14:30:25
  🔍 触发路径:   [MID-001]
  🎯 基本事件:   [EVT-001 EVT-002]
══════════════════════════════════════════════════════════════════
```

### 恢复流程

```
📌 场景 5: 所有指标恢复正常 (恢复告警)
  🟢 发送告警: BATTERY_VOLTAGE_ALERT (resolved)
  🟢 发送告警: BUS_VOLTAGE_ALERT (resolved)
  [诊断] 收到告警: BATTERY_VOLTAGE_ALERT (status=resolved, severity=info)
  [诊断] 收到告警: BUS_VOLTAGE_ALERT (status=resolved, severity=info)
```

## 故障排查

### 问题1: 构建失败

**原因：** 缺少依赖或路径错误

**解决：**
```bash
cd /home/yzj/fault-tolerance
go mod tidy
```

### 问题2: 找不到配置文件

**原因：** 相对路径错误

**解决：** 确保在项目根目录运行测试

### 问题3: 未触发故障诊断

**原因：** 故障树逻辑不满足

**解决：** 检查：
1. 基本事件的 alert_id 与健康监测的 AlertID 一致
2. 故障树的门逻辑条件
3. 是否发送了 firing 告警（而非 resolved）

### 问题4: 恢复告警未生效

**原因：** 状态管理器未启用或未使用有状态检查函数

**解决：**
- 确保使用 `NewGeneratorWithStateManager()` 创建生成器
- 使用 `CheckXxxThresholdsWithState()` 函数

## 性能指标

| 指标 | 简化版 | 完整版 |
|-----|-------|-------|
| 告警延迟 | < 1ms | < 10ms |
| 诊断延迟 | < 5ms | < 20ms |
| 内存占用 | ~30MB | ~50MB |
| CPU占用 | < 2% | < 5% |

## 相关文档

- [故障诊断状态管理](../fault-diagnosis/STATE_MANAGEMENT.md)
- [内存直接集成](../MEMORY_INTEGRATION.md)
- [故障诊断集成指南](../fault-diagnosis/INTEGRATION.md)
